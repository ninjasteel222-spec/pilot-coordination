<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Пилот</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#003b6d; }
    #map-container { position:absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; background:#003b6d; }
    #map { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) scale(1); transform-origin:center center; }
    .marker { position:absolute; width:24px; height:24px; border-radius:50%; cursor:grab; }
    #panel { position:absolute; top:10px; left:10px; width:220px; background:rgba(0,0,0,0.6); color:#fff; padding:10px; font-family:sans-serif; border-radius:8px; }
  </style>
</head>
<body>
  <div id="map-container">
    <div id="map">
      <img src="map.jpg" alt="map" style="width:100%; height:auto;">
    </div>
  </div>
  <div id="panel"><h3>Пилот</h3><div id="pilotInfo"></div></div>

  <script>
    const pilotId = "pilot-" + Math.floor(Math.random() * 10000);
    const name = prompt("Введите ваше имя:");
    const color = `hsl(${Math.floor(Math.random() * 360)}, 80%, 50%)`;

    const socket = new WebSocket(location.origin.replace(/^http/, 'ws'));
    const map = document.getElementById("map");
    const pilotInfo = document.getElementById("pilotInfo");
    const markers = {};
    let marker;
    let scale = 1;
    let translateX = 0, translateY = 0;
    let isDraggingMap = false, startX, startY;
    let verified = false;

    function updateTransform() {
      map.style.transform = `translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) scale(${scale})`;
    }

    // Зум с ограничением
    document.addEventListener("wheel", e => {
      e.preventDefault();
      const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
      scale *= zoomFactor;
      if (scale < 0.5) scale = 0.5;
      if (scale > 3.0) scale = 3.0;
      updateTransform();
    });

    // Перемещение карты
    map.addEventListener("mousedown", e => {
      if (!e.target.classList.contains("marker")) {
        isDraggingMap = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
      }
    });
    document.addEventListener("mouseup", () => { isDraggingMap = false; });
    document.addEventListener("mousemove", e => {
      if (isDraggingMap) {
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        updateTransform();
      }
    });

    function updatePanel(x, y) {
      pilotInfo.innerHTML = `
        ID: ${pilotId}<br>
        Имя: ${name}<br>
        Координаты: (${x}, ${y})<br>
        Статус: ${verified ? "✅ Верифицирован" : "❌ Не верифицирован"}
      `;
    }

    socket.onopen = () => {
      socket.send(JSON.stringify({ 
        type: "register", 
        pilotId, 
        name, 
        color 
      }));
    };

    // Drag собственной метки
    let draggingMarker = null;
    let offsetX = 0, offsetY = 0;

    map.addEventListener("mousedown", e => {
      if (e.target.classList.contains("marker") && e.target.dataset.pilotId === pilotId) {
        draggingMarker = e.target;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      }
    });

    document.addEventListener("mouseup", () => {
      if (draggingMarker) {
        const x = parseInt(draggingMarker.style.left);
        const y = parseInt(draggingMarker.style.top);
        socket.send(JSON.stringify({ type: "move", pilotId, x, y }));
        updatePanel(x, y);
        draggingMarker = null;
      }
    });

    document.addEventListener("mousemove", e => {
      if (draggingMarker) {
        const rect = map.getBoundingClientRect();
        const x = (e.clientX - rect.left - offsetX) / scale;
        const y = (e.clientY - rect.top - offsetY) / scale;
        draggingMarker.style.left = x + "px";
        draggingMarker.style.top = y + "px";
      }
    });

    socket.onmessage = event => {
      const data = JSON.parse(event.data);

      if (data.type === "pilots") {
        if (verified) {
          // показываем всех пилотов
          for (const pid in data.pilots) {
            const p = data.pilots[pid];
            if (!markers[pid]) {
              const m = document.createElement("div");
              m.className = "marker";
              m.dataset.pilotId = pid;
              m.style.left = p.x + "px";
              m.style.top = p.y + "px";

              if (p.isCoordinator) {
                m.textContent = "★";
                m.style.color = "yellow";
                m.style.fontSize = "24px";
                m.style.background = "transparent";
              } else {
                m.style.background = p.color;
                const label = document.createElement("span");
                label.textContent = p.name;
                label.style.position = "absolute";
                label.style.left = "30px";
                label.style.top = "0";
                label.style.color = "#fff";
                m.appendChild(label);
              }

              map.appendChild(m);
              markers[pid] = m;
            }
          }
        } else {
          // до верификации показываем только свою метку
          if (data.pilots[pilotId] && !marker) {
            marker = document.createElement("div");
            marker.className = "marker";
            marker.dataset.pilotId = pilotId;
            marker.style.background = color;
            marker.style.left = data.pilots[pilotId].x + "px";
            marker.style.top = data.pilots[pilotId].y + "px";

            const label = document.createElement("span");
            label.textContent = name;
            label.style.position = "absolute";
            label.style.left = "30px";
            label.style.top = "0";
            label.style.color = "#fff";
            marker.appendChild(label);

            map.appendChild(marker);
            markers[pilotId] = marker;
            updatePanel(data.pilots[pilotId].x, data.pilots[pilotId].y);
          }
        }
      }

      if (data.type === "update" && markers[data.pilotId]) {
        markers[data.pilotId].style.left = data.x + "px";
        markers[data.pilotId].style.top = data.y + "px";
        if (data.pilotId === pilotId) updatePanel(data.x, data.y);
      }

      if (data.type === "verify" && data.pilotId === pilotId) {
        verified = true;
        updatePanel(parseInt(marker.style.left), parseInt(marker.style.top));
        const utterance = new SpeechSynthesisUtterance(`Пилот ${name}, вы верифицированы`);
        utterance.lang = "ru-RU";
        speechSynthesis.speak(utterance);
      }

      if (data.type === "relocate" && data.pilotId === pilotId) {
        marker.style.left = data.x + "px";
        marker.style.top = data.y + "px";
        updatePanel(data.x, data.y);
        const utterance = new SpeechSynthesisUtterance(`Пилот ${name}, измените ваше местоположение`);
        utterance.lang = "ru-RU";
        speechSynthesis.speak(utterance);
      }
    };
  </script>
</body>
</html>
