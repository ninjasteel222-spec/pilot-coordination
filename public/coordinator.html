<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Пилот</title>
  <style>
    body { margin:0; background:#003b6d; }
    #map { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
    .marker { position:absolute; width:10px; height:10px; border-radius:50%; cursor:grab; }
    #panel { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:10px; }
    #logout { margin-top:10px; padding:5px 10px; background:red; color:#fff; border:none; border-radius:4px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="map"><img src="map.jpg" alt="map"></div>
  <div id="panel">
    <h3>Пилот</h3>
    <div id="pilotInfo"></div>
    <button id="logout">Выйти</button>
  </div>

  <script>
    // Сохраняем данные пилота в localStorage
    let pilotId = localStorage.getItem("pilotId");
    let name = localStorage.getItem("pilotName");
    let color = localStorage.getItem("pilotColor");

    if (!pilotId || !name) {
      pilotId = "pilot-" + Math.floor(Math.random()*10000);
      name = prompt("Введите ваше имя:");
      color = `hsl(${Math.floor(Math.random()*360)},80%,50%)`;
      localStorage.setItem("pilotId",pilotId);
      localStorage.setItem("pilotName",name);
      localStorage.setItem("pilotColor",color);
    }

    document.getElementById("logout").onclick = () => {
      localStorage.clear();
      location.reload();
    };

    // Подключение к WebSocket
    const socket = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") + location.host
    );

    const map = document.getElementById("map");
    const pilotInfo = document.getElementById("pilotInfo");
    let marker;
    let verified = false;

    function updateInfo(x,y,verifiedFlag) {
      pilotInfo.innerHTML=`ID:${pilotId}<br>Имя:${name}<br>(${x},${y})<br>${verifiedFlag?"✅ Верифицирован":"❌ Не верифицирован"}`;
    }

    socket.onopen = () => {
      console.log("WebSocket open, registering pilot...");
      socket.send(JSON.stringify({type:"register",pilotId,name,color}));
    };

    socket.onmessage = e => {
      const data = JSON.parse(e.data);
      console.log("Message from server:", data);

      if (data.type==="pilots") {
        const p=data.pilots[pilotId];
        if (p && !marker) {
          marker=document.createElement("div");
          marker.className="marker";
          marker.dataset.pilotId = pilotId;
          marker.style.left=p.x+"px"; marker.style.top=p.y+"px";
          marker.style.background=color;

          const label = document.createElement("span");
          label.textContent = name;
          label.style.position = "absolute";
          label.style.left = "15px";
          label.style.top = "0";
          label.style.color = "#fff";
          marker.appendChild(label);

          map.appendChild(marker);
          updateInfo(p.x,p.y,p.verified);
        }
      }

      if (data.type==="verify" && data.pilotId===pilotId) {
        verified = true;
        updateInfo(parseInt(marker.style.left), parseInt(marker.style.top), true);
      }

      if (data.type==="disconnect" && data.pilotId===pilotId) {
        localStorage.clear();
        alert("Вас отключил координатор");
        location.reload();
      }

      if ((data.type==="relocate"||data.type==="move") && data.pilotId===pilotId) {
        marker.style.left=data.x+"px"; marker.style.top=data.y+"px";
        updateInfo(data.x,data.y,verified);
      }
    };

    // Возможность двигать свою метку мышкой
    document.addEventListener("mousedown", e => {
      if (marker && e.target===marker) {
        const startX = e.clientX - parseInt(marker.style.left);
        const startY = e.clientY - parseInt(marker.style.top);
        function onMove(ev) {
          const x = ev.clientX - startX;
          const y = ev.clientY - startY;
          marker.style.left = x+"px";
          marker.style.top = y+"px";
          socket.send(JSON.stringify({type:"move",pilotId,x,y}));
          updateInfo(x,y,verified);
        }
        function onUp() {
          document.removeEventListener("mousemove",onMove);
          document.removeEventListener("mouseup",onUp);
        }
        document.addEventListener("mousemove",onMove);
        document.addEventListener("mouseup",onUp);
      }
    });
  </script>
</body>
</html>
