<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Координатор</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#003b6d; }
    #map-container { position:absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; background:#003b6d; }
    #map { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) scale(1); transform-origin:center center; }
    .marker { position:absolute; width:24px; height:24px; border-radius:50%; color:#fff; font-size:14px; cursor:grab; }
    #panel { position:absolute; top:10px; right:10px; width:250px; max-height:90%; background:rgba(0,0,0,0.6); color:#fff; padding:10px; font-family:sans-serif; overflow-y:auto; border-radius:8px; }
    .pilot-entry { margin-bottom:8px; padding:6px; background:rgba(255,255,255,0.1); border-radius:4px; }
    .verify-btn, .disconnect-btn { margin-left:5px; padding:2px 6px; border:none; border-radius:4px; cursor:pointer; }
    .verify-btn { background:green; color:#fff; }
    .disconnect-btn { background:red; color:#fff; }
  </style>
</head>
<body>
  <div id="map-container">
    <div id="map">
      <img src="map.jpg" alt="map" style="width:100%; height:auto;">
    </div>
  </div>
  <div id="panel"><h3>Пилоты</h3><div id="pilotList"></div></div>

  <script>
    const socket = new WebSocket(location.origin.replace(/^http/, 'ws'));
    const map = document.getElementById("map");
    const pilotList = document.getElementById("pilotList");
    const markers = {};
    let scale = 1;
    let translateX = 0, translateY = 0;
    let isDraggingMap = false, startX, startY;

    function updateTransform() {
      map.style.transform = `translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) scale(${scale})`;
    }

    // Зум
    document.addEventListener("wheel", e => {
      e.preventDefault();
      scale *= e.deltaY < 0 ? 1.1 : 0.9;
      updateTransform();
    });

    // Перемещение карты
    map.addEventListener("mousedown", e => {
      if (!e.target.classList.contains("marker")) {
        isDraggingMap = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
      }
    });
    document.addEventListener("mouseup", () => { isDraggingMap = false; });
    document.addEventListener("mousemove", e => {
      if (isDraggingMap) {
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        updateTransform();
      }
    });

    // Панель пилотов
    function updatePanel(pilots) {
      pilotList.innerHTML = "";
      for (const pilotId in pilots) {
        const p = pilots[pilotId];
        const entry = document.createElement("div");
        entry.className = "pilot-entry";
        entry.textContent = `${p.name} (${pilotId}): (${p.x}, ${p.y}) ${p.verified ? "✅" : "❌"}`;

        const btnVerify = document.createElement("button");
        btnVerify.className = "verify-btn";
        btnVerify.textContent = "Вериф.";
        btnVerify.onclick = () => socket.send(JSON.stringify({ type: "verify", pilotId }));

        const btnDisconnect = document.createElement("button");
        btnDisconnect.className = "disconnect-btn";
        btnDisconnect.textContent = "Откл.";
        btnDisconnect.onclick = () => socket.send(JSON.stringify({ type: "disconnect", pilotId }));

        entry.appendChild(btnVerify);
        entry.appendChild(btnDisconnect);
        pilotList.appendChild(entry);
      }
    }

    // Drag меток пилотов
    let draggingMarker = null;
    let dragPilotId = null;
    let offsetX = 0, offsetY = 0;

    map.addEventListener("mousedown", e => {
      if (e.target.classList.contains("marker")) {
        draggingMarker = e.target;
        dragPilotId = e.target.dataset.pilotId;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      }
    });

    document.addEventListener("mouseup", () => {
      if (draggingMarker && dragPilotId) {
        const x = parseInt(draggingMarker.style.left);
        const y = parseInt(draggingMarker.style.top);
        socket.send(JSON.stringify({ type: "relocate", pilotId: dragPilotId, x, y }));
        draggingMarker = null;
        dragPilotId = null;
      }
    });

    document.addEventListener("mousemove", e => {
      if (draggingMarker) {
        draggingMarker.style.left = (e.pageX - offsetX) + "px";
        draggingMarker.style.top = (e.pageY - offsetY) + "px";
      }
    });

    // Обработка сообщений
    socket.onmessage = event => {
      const data = JSON.parse(event.data);

      if (data.type === "pilots") {
        updatePanel(data.pilots);
        for (const pilotId in data.pilots) {
          const p = data.pilots[pilotId];
          if (!markers[pilotId]) {
            const marker = document.createElement("div");
            marker.className = "marker";
            marker.dataset.pilotId = pilotId;
            marker.style.left = p.x + "px";
            marker.style.top = p.y + "px";

            if (p.isCoordinator) {
              marker.textContent = "★";
              marker.style.color = "yellow";
              marker.style.fontSize = "24px";
              marker.style.background = "transparent";
            } else {
              marker.style.background = p.color;
              const label = document.createElement("span");
              label.textContent = p.name;
              label.style.position = "absolute";
              label.style.left = "30px";
              label.style.top = "0";
              label.style.color = "#fff";
              marker.appendChild(label);
            }

            map.appendChild(marker);
            markers[pilotId] = marker;
          }
        }
      }

      if (data.type === "update" || data.type === "relocate") {
        if (markers[data.pilotId]) {
          markers[data.pilotId].style.left = data.x + "px";
          markers[data.pilotId].style.top = data.y + "px";
        }
      }
    };

    socket.onopen = () => {
      socket.send(JSON.stringify({ type: "register", pilotId: "coordinator", name: "Координатор", isCoordinator: true }));
    };
  </script>
</body>
</html>
