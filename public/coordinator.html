<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Координатор</title>
  <style>
    body { margin:0; background:#003b6d; }
    #map-container { position:absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; }
    #map { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); transform-origin:center center; }
    .marker { position:absolute; width:12px; height:12px; border-radius:50%; cursor:grab; }
    #panel { position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:#fff; padding:10px; width:250px; border-radius:8px; }
  </style>
</head>
<body>
  <div id="map-container">
    <div id="map"><img src="map.jpg" alt="map"></div>
  </div>
  <div id="panel"><h3>Пилоты</h3><div id="pilotList"></div></div>

  <script>
    const socket = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.host);
    const map = document.getElementById("map");
    const pilotList = document.getElementById("pilotList");
    const markers = {};
    let scale=1, translateX=0, translateY=0, dragging=false, startX, startY;

    function updateTransform(){
      map.style.transform=`translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) scale(${scale})`;
    }

    document.addEventListener("wheel",e=>{
      e.preventDefault();
      scale*= e.deltaY<0?1.1:0.9;
      if(scale<0.2) scale=0.2;
      updateTransform();
    });

    map.addEventListener("mousedown",e=>{
      if(!e.target.classList.contains("marker")){
        dragging=true; startX=e.clientX-translateX; startY=e.clientY-translateY;
      }
    });
    document.addEventListener("mouseup",()=>dragging=false);
    document.addEventListener("mousemove",e=>{
      if(dragging){ translateX=e.clientX-startX; translateY=e.clientY-startY; updateTransform(); }
    });

    function updatePanel(pilots){
      pilotList.innerHTML="";
      for(const id in pilots){
        const p=pilots[id];
        const div=document.createElement("div");
        div.textContent=`${p.name} (${id}) ${p.verified?"✅":"❌"}`;
        pilotList.appendChild(div);
      }
    }

    socket.onmessage=e=>{
      const data=JSON.parse(e.data);
      if(data.type==="pilots"){
        updatePanel(data.pilots);
        for(const id in data.pilots){
          const p=data.pilots[id];
          if(!markers[id]){
            const m=document.createElement("div");
            m.className="marker";
            m.style.left=p.x+"px"; m.style.top=p.y+"px";
            m.style.background=p.isCoordinator?"yellow":p.color;
            map.appendChild(m);
            markers[id]=m;
          }
        }
      }
      if(["move","relocate"].includes(data.type)){
        if(markers[data.pilotId]){
          markers[data.pilotId].style.left=data.x+"px";
          markers[data.pilotId].style.top=data.y+"px";
        }
      }
    };

    socket.onopen=()=>socket.send(JSON.stringify({type:"register",pilotId:"coordinator",name:"Координатор",isCoordinator:true}));
  </script>
</body>
</html>
