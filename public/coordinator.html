<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Координатор</title>
  <style>
    body { margin:0; background:#003b6d; }
    #map { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
    .marker { position:absolute; width:12px; height:12px; border-radius:50%; cursor:grab; }
    #panel { position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:#fff; padding:10px; width:250px; border-radius:8px; }
    .pilot-entry { margin-bottom:8px; padding:6px; background:rgba(255,255,255,0.1); border-radius:4px; }
    .verify-btn, .disconnect-btn { margin-left:5px; padding:2px 6px; border:none; border-radius:4px; cursor:pointer; }
    .verify-btn { background:green; color:#fff; }
    .disconnect-btn { background:red; color:#fff; }
  </style>
</head>
<body>
  <div id="map"><img src="map.jpg" alt="map"></div>
  <div id="panel"><h3>Пилоты</h3><div id="pilotList"></div></div>

  <script>
    const socket = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") + location.host
    );
    const map = document.getElementById("map");
    const pilotList = document.getElementById("pilotList");
    const markers = {};

    function updatePanel(pilots) {
      pilotList.innerHTML = "";
      for (const id in pilots) {
        const p = pilots[id];
        const entry = document.createElement("div");
        entry.className = "pilot-entry";
        entry.textContent = `${p.name} (${id}) ${p.verified ? "✅" : "❌"}`;

        const btnVerify = document.createElement("button");
        btnVerify.className = "verify-btn";
        btnVerify.textContent = "Вериф.";
        btnVerify.onclick = () => socket.send(JSON.stringify({type:"verify",pilotId:id}));

        const btnDisconnect = document.createElement("button");
        btnDisconnect.className = "disconnect-btn";
        btnDisconnect.textContent = "Откл.";
        btnDisconnect.onclick = () => socket.send(JSON.stringify({type:"disconnect",pilotId:id}));

        entry.appendChild(btnVerify);
        entry.appendChild(btnDisconnect);
        pilotList.appendChild(entry);
      }
    }

    socket.onmessage = e => {
      const data = JSON.parse(e.data);

      if (data.type === "pilots") {
        updatePanel(data.pilots);
        for (const id in data.pilots) {
          const p = data.pilots[id];
          if (!markers[id]) {
            const m = document.createElement("div");
            m.className="marker";
            m.dataset.pilotId = id;
            m.style.left=p.x+"px"; m.style.top=p.y+"px";
            if (p.isCoordinator) {
              m.textContent="★";
              m.style.color="yellow";
              m.style.fontSize="16px";
              m.style.background="transparent";
            } else {
              m.style.background=p.color;
              const label=document.createElement("span");
              label.textContent=p.name;
              label.style.position="absolute";
              label.style.left="15px";
              label.style.top="0";
              label.style.color="#fff";
              m.appendChild(label);
            }
            map.appendChild(m);
            markers[id]=m;
          }
        }
      }

      if (["update","relocate","move"].includes(data.type)) {
        if (markers[data.pilotId]) {
          markers[data.pilotId].style.left=data.x+"px";
          markers[data.pilotId].style.top=data.y+"px";
        }
      }

      if (data.type==="error" && data.message==="Координатор уже активен") {
        alert("Координатор уже активен на другом устройстве. Вход невозможен.");
        socket.close();
        window.location.href="/";
      }
    };

    socket.onopen = () => {
      socket.send(JSON.stringify({type:"register",pilotId:"coordinator",name:"Координатор",isCoordinator:true}));
    };

    // Возможность двигать метку координатора
    document.addEventListener("mousedown", e => {
      if (markers["coordinator"] && e.target===markers["coordinator"]) {
        const startX = e.clientX - parseInt(markers["coordinator"].style.left);
        const startY = e.clientY - parseInt(markers["coordinator"].style.top);
        function onMove(ev) {
          const x = ev.clientX - startX;
          const y = ev.clientY - startY;
          markers["coordinator"].style.left=x+"px";
          markers["coordinator"].style.top=y+"px";
          socket.send(JSON.stringify({type:"move",pilotId:"coordinator",x,y}));
        }
        function onUp() {
          document.removeEventListener("mousemove",onMove);
          document.removeEventListener("mouseup",onUp);
        }
        document.addEventListener("mousemove",onMove);
        document.addEventListener("mouseup",onUp);
      }
    });
  </script>
</body>
</html>
